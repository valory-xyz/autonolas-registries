# Preconditioned Fuzzing
In order to precondition fuzzing to a specific state of contracts, the following workflow has been executed:
- Install [Etheno](https://github.com/crytic/etheno) tool (`pip3 install --user etheno`);
- Read the [E2E testing guide](https://github.com/crytic/building-secure-contracts/blob/master/program-analysis/echidna/advanced/end-to-end-testing.md);
- Run the etheno node with setup JSON writing option (`etheno --ganache -x output_file.json`);
- In a separate terminal, run the hardhat script test that gets all the contracts in the desired state connected to the node (`npx hardhat test test_file.js --network local`);
- Add `initialize` field into the `echidna.yaml` file with the JSON produced after the script run;
- Now echidna can start with the state of contracts from the point where the script run has terminated.



```sh
echidna-test contracts/flatten/AgentRegistry-flatten.sol --contract AgentRegistryProxy --config echidna.yaml                                                                                                                                                                                   
                                                         
                                                          ┌─────────────────────────────────────────────────────Echidna 2.0.5────────────────────────────────────────────────────┐                                                          
                                                          │ Tests found: 1                                                                                                       │                                                          
                                                          │ Seed: -1325617478790951267                                                                                           │                                                          
                                                          │ Unique instructions: 1947                                                                                            │                                                          
                                                          │ Unique codehashes: 2                                                                                                 │                                                          
                                                          │ Corpus size: 2                                                                                                       │                                                          
                                                          │─────────────────────────────────────────────────────────Tests────────────────────────────────────────────────────────│                                                          
                                                          │ Integer (over/under)flow: PASSED!                                                                                    │                                                          
                                                          └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  

echidna-test contracts/flatten/AgentRegistry-flatten.sol --contract AgentRegistryProxy --config echidna.yaml 
                                                          ┌─────────────────────────────────────────────────────Echidna 2.0.5────────────────────────────────────────────────────┐                                                          
                                                          │ Tests found: 4                                                                                                       │                                                          
                                                          │ Seed: 2056738752459694098                                                                                            │                                                          
                                                          │ Unique instructions: 1947                                                                                            │                                                          
                                                          │ Unique codehashes: 2                                                                                                 │                                                          
                                                          │ Corpus size: 1                                                                                                       │                                                          
                                                          │─────────────────────────────────────────────────────────Tests────────────────────────────────────────────────────────│                                                          
                                                          │ AssertionFailed(..): PASSED!                                                                                         │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in iComponentRegistryFF(): PASSED!                                                                         │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in iAgentRegistryF(): PASSED!                                                                              │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in calculateSubComponents(uint32[]): PASSED!                                                               │                                                          
                                                          └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘                                                          
                                                                                                   Campaign complete, C-c or esc to exit
                                                                                                    
echidna-test contracts/flatten/ServiceRegistry-flatten.sol --contract ServiceRegistryProxy --config echidna.yaml                                                                                                                                                                                    
                                                          ┌─────────────────────────────────────────────────────Echidna 2.0.5────────────────────────────────────────────────────┐                                                          
                                                          │ Tests found: 22                                                                                                      │                                                          
                                                          │ Seed: -7513038944257559547                                                                                           │                                                          
                                                          │ Unique instructions: 11784                                                                                           │                                                          
                                                          │ Unique codehashes: 2                                                                                                 │                                                          
                                                          │ Corpus size: 19                                                                                                      │                                                          
                                                          │─────────────────────────────────────────────────────────Tests────────────────────────────────────────────────────────│                                                          
                                                          │ AssertionFailed(..): PASSED!                                                                                         │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in deploy(address,uint256,address,bytes): PASSED!                                                          │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in getService(uint256): PASSED!                                                                            │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in activateRegistration(address,uint256): PASSED!                                                          │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in registerAgents(address,uint256,address[],uint32[]): PASSED!                                             │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in terminate(address,uint256): PASSED!                                                                     │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in create(address,bytes32,uint32[],(uint32,uint96)[],uint32): PASSED!                                      │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in getPreviousHashes(uint256): PASSED!                                                                     │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in unbond(address,uint256): PASSED!                                                                        │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in drain(): PASSED!                                                                                        │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in getUnitIdsOfService(uint8,uint256): PASSED!                                                             │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in getOperatorBalance(address,uint256): PASSED!                                                            │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in changeMultisigPermission(address,bool): PASSED!                                                         │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in slash(address[],uint96[],uint256): PASSED!                                                              │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in getAgentInstances(uint256): PASSED!                                                                     │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in iServiceRegistryF(): PASSED!                                                                            │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in iComponentRegistryFF(): PASSED!                                                                         │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in getInstancesForAgentId(uint256,uint256): PASSED!                                                        │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in getAgentParams(uint256): PASSED!                                                                        │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in iAgentRegistryF(): PASSED!                                                                              │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in changeDrainer(address): PASSED!                                                                         │                                                          
                                                          │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│                                                          
                                                          │ assertion in update(address,bytes32,uint32[],(uint32,uint96)[],uint32,uint256): PASSED!                              │                                                          
                                                          └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘                                                          
                                                                                                   Campaign complete, C-c or esc to exit                                                                                                    
                                                                                                                                             

```
